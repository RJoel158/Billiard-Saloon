# ğŸ—ï¸ Arquitectura del Sistema de Login

## Diagrama General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE (Frontend)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  1. POST /auth/register â†’ Crear usuario                       â”‚ â”‚
â”‚  â”‚  2. POST /auth/login â†’ Obtener tokens                         â”‚ â”‚
â”‚  â”‚  3. GET /api/users + Bearer Token â†’ Datos protegidos          â”‚ â”‚
â”‚  â”‚  4. POST /auth/refresh-token â†’ Renovar token                  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP/REST API
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVIDOR EXPRESS (Backend)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Routes (src/routes/)                                           â”‚ â”‚
â”‚  â”‚  â”œâ”€ auth.routes.js â†’ /auth/**                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ user.routes.js â†’ /users/**                                â”‚ â”‚
â”‚  â”‚  â””â”€ [...otras rutas]                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Middlewares (src/middlewares/)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ auth.middleware.js â† Valida JWT                           â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ authMiddleware()    â† Verifica token                  â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ adminMiddleware()   â† Verifica role_id=1              â”‚ â”‚
â”‚  â”‚  â”œâ”€ errorHandler.js â† Maneja errores                          â”‚ â”‚
â”‚  â”‚  â””â”€ apiError.js â† Define errores API                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Controllers (src/controllers/)                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ auth.controller.js                                        â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ register()                                            â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ login()                                               â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ changeTemporaryPassword()                             â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ refreshTokenEndpoint()                                â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ logout()                                              â”‚ â”‚
â”‚  â”‚  â””â”€ [...otros controllers]                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Services (src/services/)                                       â”‚ â”‚
â”‚  â”‚  â”œâ”€ auth.service.js                                           â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ generateToken()      â† Crea JWT                       â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ verifyToken()        â† Valida JWT                     â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ generateRefreshToken() â† Crea refresh                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ user.service.js                                           â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ createUser()                                          â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ getUserByEmail()                                      â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ [...]                                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ email.service.js                                          â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ sendWelcomeEmail()    â† ContraseÃ±a temporal          â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ sendPasswordResetEmail()                              â”‚ â”‚
â”‚  â”‚  â””â”€ [...otros servicios]                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Repositories (src/repositories/)                               â”‚ â”‚
â”‚  â”‚  â”œâ”€ user.repository.js                                        â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ findById()                                            â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ findByEmail()                                         â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ create()      â† INSERT usuario                        â”‚ â”‚
â”‚  â”‚  â”‚   â”œâ”€ update()      â† UPDATE usuario                        â”‚ â”‚
â”‚  â”‚  â”‚   â””â”€ deleteById()                                          â”‚ â”‚
â”‚  â”‚  â””â”€ [...otros repositorios]                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Database (src/db/)                                             â”‚ â”‚
â”‚  â”‚  â”œâ”€ db.js â† ConexiÃ³n MySQL                                   â”‚ â”‚
â”‚  â”‚  â””â”€ schema.js â† InformaciÃ³n de tablas                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ SQL Queries
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BASE DE DATOS (MySQL)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ TABLE: users                                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ id (PK)                                                  â”‚ â”‚
â”‚  â”‚  â”œâ”€ role_id (FK) â†’ roles                                     â”‚ â”‚
â”‚  â”‚  â”œâ”€ first_name                                               â”‚ â”‚
â”‚  â”‚  â”œâ”€ last_name                                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ email (UNIQUE) â† Clave para login                        â”‚ â”‚
â”‚  â”‚  â”œâ”€ password_hash â† Encriptado con bcrypt                    â”‚ â”‚
â”‚  â”‚  â”œâ”€ phone                                                    â”‚ â”‚
â”‚  â”‚  â””â”€ created_at                                               â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚ TABLE: roles                                                 â”‚ â”‚
â”‚  â”‚  â”œâ”€ id (PK)                                                  â”‚ â”‚
â”‚  â”‚  â””â”€ name (admin, client)                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ EnvÃ­o de emails
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICIO DE EMAIL (Gmail)                        â”‚
â”‚  â”œâ”€ nodemailer.createTransport()                                   â”‚
â”‚  â”œâ”€ auth con GMAIL_USER y GMAIL_PASSWORD                           â”‚
â”‚  â””â”€ sendWelcomeEmail()                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo: POST /auth/login

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cliente envÃ­a: â”‚
â”‚ {             â”‚
â”‚  email,       â”‚
â”‚  password     â”‚
â”‚ }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ POST /api/auth/login
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth.routes.js                          â”‚
â”‚ router.post('/login', authController)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth.controller.login()                 â”‚
â”‚                                         â”‚
â”‚ 1. Valida email y password              â”‚
â”‚ 2. Busca usuario por email              â”‚
â”‚ 3. Compara password con bcrypt          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.service.getUserByEmail(email)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.repository.findByEmail(email)      â”‚
â”‚ â†’ SELECT * FROM users WHERE email = ?   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Base de datos retorna usuario           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bcrypt.compare(password, hash)          â”‚
â”‚ Â¿ContraseÃ±a vÃ¡lida?                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚          â”‚
   SÃ         NO
    â”‚          â”‚
    â†“          â†“
  [OK]    [401 INVALID]
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth.service.generateToken()            â”‚
â”‚ â†’ Crear JWT (Access)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth.service.generateRefreshToken()     â”‚
â”‚ â†’ Crear JWT (Refresh)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response (200 OK):                  â”‚
â”‚ {                                   â”‚
â”‚   token: "eyJ...",                  â”‚
â”‚   refreshToken: "eyJ...",           â”‚
â”‚   user: { id, email, role_id }      â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo: GET /api/users (Ruta Protegida)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cliente envÃ­a:                   â”‚
â”‚ GET /api/users                   â”‚
â”‚ Authorization: Bearer eyJ...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.routes.js                           â”‚
â”‚ router.get('/users',                     â”‚
â”‚            authMiddleware,  â† AQUI!     â”‚
â”‚            userController)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ authMiddleware                           â”‚
â”‚                                          â”‚
â”‚ 1. Extrae Authorization header           â”‚
â”‚ 2. Obtiene token de "Bearer eyJ..."      â”‚
â”‚ 3. Valida JWT signature                  â”‚
â”‚ 4. Extrae payload { user_id, role_id }  â”‚
â”‚ 5. Agrega a req.user                     â”‚
â”‚ 6. Llama next() para continuar           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
 Â¿Token          Â¿Token
  vÃ¡lido?         invÃ¡lido?
    â”‚             â”‚
    â†“             â†“
 [OK]        [401 INVALID]
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.controller.getAllUsers()            â”‚
â”‚                                          â”‚
â”‚ Accede a: req.user                       â”‚
â”‚ { user_id: 1, role_id: 2, email: "..." } â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.service.getAllUsers()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.repository.findAll()                â”‚
â”‚ â†’ SELECT * FROM users                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response (200 OK):                       â”‚
â”‚ [                                        â”‚
â”‚   { id, role_id, first_name, ... },      â”‚
â”‚   { id, role_id, first_name, ... }       â”‚
â”‚ ]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Componentes y Responsabilidades

### ğŸ” **auth.service.js** - Manejo de Tokens JWT
```
generateToken(userId, roleId, email)
â”œâ”€ Crea payload
â”œâ”€ Firma con JWT_SECRET
â”œâ”€ Devuelve token vÃ¡lido 24h

verifyToken(token)
â”œâ”€ Valida firma
â”œâ”€ Verifica expiraciÃ³n
â”œâ”€ Retorna payload

generateRefreshToken(userId)
â”œâ”€ Crea payload simple
â”œâ”€ Firma con REFRESH_TOKEN_SECRET
â””â”€ Devuelve token vÃ¡lido 7d
```

### ğŸ”‘ **auth.controller.js** - LÃ³gica de AutenticaciÃ³n
```
register()
â”œâ”€ Valida datos
â”œâ”€ Genera contraseÃ±a temporal
â”œâ”€ Encripta con bcrypt
â”œâ”€ Crea usuario
â””â”€ EnvÃ­a email

login()
â”œâ”€ Valida email y password
â”œâ”€ Compara con bcrypt
â”œâ”€ Genera tokens
â””â”€ Retorna usuario + tokens

changeTemporaryPassword()
â”œâ”€ Valida token (authMiddleware)
â”œâ”€ Encripta nueva contraseÃ±a
â””â”€ Actualiza en BD

refreshTokenEndpoint()
â”œâ”€ Valida refresh token
â”œâ”€ Genera nuevo access token
â””â”€ Retorna nuevos tokens
```

### ğŸ›¡ï¸ **auth.middleware.js** - ProtecciÃ³n de Rutas
```
authMiddleware()
â”œâ”€ Extrae Authorization header
â”œâ”€ Valida JWT signature
â”œâ”€ Agrega req.user
â””â”€ ContinÃºa si es vÃ¡lido

adminMiddleware()
â”œâ”€ Verifica req.user existe
â”œâ”€ Verifica role_id === 1
â””â”€ ContinÃºa si es admin
```

### ğŸ‘¤ **user.service.js** - LÃ³gica de Usuarios
```
getUser(id) - GET usuario por ID
getUserByEmail(email) - GET usuario por email
createUser(data) - CREATE nuevo usuario
getAllUsers() - GET todos usuarios
updateUser(id, data) - UPDATE usuario
deleteUser(id) - DELETE usuario
```

### ğŸ’¾ **user.repository.js** - Consultas SQL
```
findById(id)
â”œâ”€ SELECT por ID

findByEmail(email)
â”œâ”€ SELECT por email (sin password en registro)

create(user)
â”œâ”€ INSERT usuario

update(id, user)
â”œâ”€ UPDATE usuario

deleteById(id)
â”œâ”€ DELETE/soft-delete usuario
```

### ğŸ“§ **email.service.js** - EnvÃ­o de Emails
```
sendWelcomeEmail(email, firstName, tempPassword)
â”œâ”€ Crea HTML template
â”œâ”€ EnvÃ­a con nodemailer
â””â”€ Include contraseÃ±a temporal

sendPasswordResetEmail(email, resetToken)
â”œâ”€ Crea HTML template
â”œâ”€ Incluye link de reset
â””â”€ EnvÃ­a con nodemailer
```

---

## Matriz de AutorizaciÃ³n

| Endpoint | MÃ©todo | Auth | Admin | DescripciÃ³n |
|----------|--------|------|-------|-------------|
| /register | POST | âŒ | âŒ | Registrar usuario |
| /login | POST | âŒ | âŒ | Login |
| /refresh-token | POST | âŒ | âŒ | Renovar token |
| /logout | POST | âœ… | âŒ | Logout |
| /change-password | POST | âœ… | âŒ | Cambiar contraseÃ±a |
| /users | GET | âœ… | âŒ | Ver todos usuarios |
| /users/:id | GET | âœ… | âŒ | Ver usuario |
| /users/:id | PUT | âœ… | âŒ | Editar usuario |
| /users/:id | DELETE | âœ… | âœ… | Eliminar usuario |

---

## Flujo de Datos (TypeScript-style)

```typescript
// REGISTRO
interface RegisterRequest {
  first_name: string;
  last_name: string;
  email: string;
}

interface User {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  password_hash: string; // bcrypt hash
  role_id: number; // 1=admin, 2=client
  created_at: Date;
}

// LOGIN
interface LoginRequest {
  email: string;
  password: string;
}

interface TokenPayload {
  user_id: number;
  role_id: number;
  email: string;
  iat: number; // issued at
  exp: number; // expiration
}

interface LoginResponse {
  token: string;           // JWT (24h)
  refreshToken: string;    // JWT (7d)
  user: Partial<User>;     // sin password_hash
}
```

---

## Tabla de DecisiÃ³n de Seguridad

```
Solicitud â†’ Â¿Requiere Auth?
              â”‚
              â”œâ”€ NO â†’ Procesar directamente
              â”‚       (register, login)
              â”‚
              â””â”€ SÃ â†’ Â¿Tiene Authorization header?
                      â”‚
                      â”œâ”€ NO â†’ 401 MISSING_TOKEN
                      â”‚
                      â””â”€ SÃ â†’ Â¿Token es vÃ¡lido?
                              â”‚
                              â”œâ”€ NO â†’ 401 INVALID_TOKEN
                              â”‚
                              â””â”€ SÃ â†’ Â¿Es admin?
                                      â”‚
                                      â”œâ”€ SÃ (si se requiere)
                                      â”‚    â†’ Procesar
                                      â”‚
                                      â””â”€ NO (si se requiere)
                                           â†’ 403 FORBIDDEN
```

---

## Ciclo de Vida de un Token

```
1. GENERACIÃ“N
   jwt.sign() con payload + secret
   â†“
2. ALMACENAMIENTO
   Cliente: localStorage/sessionStorage
   â†“
3. USO
   Cliente: Authorization header en requests
   â†“
4. VALIDACIÃ“N
   Servidor: jwt.verify() y fecha expiraciÃ³n
   â†“
5. EXPIRACIÃ“N
   JWT automÃ¡ticamente invÃ¡lido despuÃ©s de exp
   â†“
6. RENOVACIÃ“N
   Cliente usa refreshToken para obtener nuevo token
   â†“
7. REEMPLAZO
   Nuevo token vÃ¡lido por otros 24h
```

---

Â¡Este es el corazÃ³n del sistema de autenticaciÃ³n! ğŸ’ª
